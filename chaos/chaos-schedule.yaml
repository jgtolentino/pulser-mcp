# Chaos Engineering Schedule for Pulser MCP
# Automated failure injection to test resilience

schedule:
  # Daily minor chaos (business hours)
  - name: "Service Restart Test"
    cron: "0 10 * * 1-5"  # 10 AM weekdays
    mode: "service"
    duration: 30
    notify: false
    
  - name: "API Failure Injection"
    cron: "0 14 * * 1-5"  # 2 PM weekdays
    mode: "api"
    duration: 60
    notify: false

  # Weekly moderate chaos
  - name: "Network Partition Test"
    cron: "0 3 * * 3"  # Wednesday 3 AM
    mode: "network"
    duration: 120
    notify: true
    
  - name: "Resource Exhaustion Test"
    cron: "0 3 * * 5"  # Friday 3 AM
    mode: "resource"
    duration: 60
    notify: true

  # Monthly severe chaos
  - name: "Database Failure Simulation"
    cron: "0 2 15 * *"  # 15th of month, 2 AM
    mode: "database"
    duration: 180
    notify: true
    alert_team: true
    
  - name: "SSE Bridge Failure"
    cron: "0 2 20 * *"  # 20th of month, 2 AM
    mode: "sse"
    duration: 300
    notify: true
    alert_team: true

  # Quarterly disaster simulation
  - name: "Full Random Chaos"
    cron: "0 2 1 */3 *"  # First day of quarter
    mode: "random"
    duration: 600
    notify: true
    alert_team: true
    require_approval: true

# Test scenarios
scenarios:
  - name: "Black Friday Simulation"
    description: "Simulate high load + random failures"
    steps:
      - mode: "resource"
        duration: 300
      - wait: 60
      - mode: "api"
        duration: 120
      - wait: 60
      - mode: "service"
        duration: 60
        
  - name: "Cascading Failure Test"
    description: "Test dependency failure handling"
    steps:
      - mode: "database"
        duration: 60
      - mode: "service"
        target: "shared_memory_mcp"
        duration: 120
      - mode: "network"
        duration: 60

# Chaos policies
policies:
  # Safety checks
  pre_checks:
    - name: "Backup exists"
      command: "test -f /backups/latest-encrypted.tar.gz"
      required: true
      
    - name: "Low traffic period"
      command: "pulser traffic-check --threshold 1000"
      required: false
      
    - name: "No ongoing incidents"
      command: "pulser incidents list --status open | grep -q '0 incidents'"
      required: true

  # Blast radius limits
  limits:
    max_services_affected: 3
    max_duration_minutes: 30
    min_interval_hours: 4
    
  # Automatic recovery
  recovery:
    enabled: true
    max_recovery_time: 300  # 5 minutes
    escalate_after: 600     # 10 minutes
    
  # Exclusions
  exclude:
    services: []  # Add critical services to exclude
    times:
      - "00:00-06:00"  # Maintenance window
      - "17:00-19:00"  # Peak hours
    dates:
      - "2024-12-24"  # Christmas Eve
      - "2024-12-25"  # Christmas
      - "2024-12-31"  # New Year's Eve